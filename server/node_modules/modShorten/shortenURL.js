//////////////////////////////////////////////////////////////////////////
// File: shortenURL.js
//
// Description: 
//   Takes a URL and an IP address and inserts it into the database.
//      A unique string key is produced that allows fetching the URL again later
//////////////////////////////////////////////////////////////////////////
var mySql = require('mysql');
var next = 0,
    clients = {},
    blacklist = {};

exports.shorten = function(data, cb, errorCB) {
   var clientID = data.clientID,
       regex = /^(?:(?:https?:\/\/)(?:[a-zA-Z0-9]*[-a-zA-Z0-9]*[a-zA-Z0-9])(?:\\.[a-zA-Z0-9]*[-a-zA-Z0-9]*[a-zA-Z0-9])*(?:\\.[a-zA-Z]{2,6}))$/;
   if (data && data.url) {
     // Validiate the url against our regex
     regex.exec(data.url);

     // Check for black-listed clients
     if (blacklist[clientID] !== undefined) {
       errorCB(BLACKLIST);
     }

     // Throttle the connected client
     if (clients[clientID] === undefined) {
       // First time
       clients[clientID] = 0;
       setTimeout(function() {
         // After 24 hours, reset the throttling
         delete clients[clientID];
       }, 86400000);

       cb("http://kili.us/+/1");

     } else if (clients[clientID] < 25) {
       clients[clientID] += 1;
       cb("http://kili.us/+/" + clients[clientID]);

     } else {
       errorCB(LIMIT);
     }
   }
}