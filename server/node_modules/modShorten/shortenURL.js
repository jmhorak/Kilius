//////////////////////////////////////////////////////////////////////////
// File: shortenURL.js
//
// Description: 
//   Takes a URL and an IP address and inserts it into the database.
//      A unique string key is produced that allows fetching the URL again later
//////////////////////////////////////////////////////////////////////////
var clients = {},
    blacklist = {},
    lan = ['1', '2', '3', '4', '5', '6', '7', '8', '9', '0', 'b', 'c', 'd', 'f', 'g', 'h', 'j',
           'k', 'l', 'm', 'n', 'p', 'q', 'r', 's', 't', 'v', 'w', 'x', 'y', 'z'];

var getNextShortenedURL = function(data, cb) {
  var counter = data.database.collection('counter'),
      links = data.database.collection('links'),
      throwOnErr = function(err) { if (err) { throw err; } };

  counter.findAndModify({tbl: 'links'}, [], {$inc: {c: 1}}, {safe: true, new: true },
    function(err, result) {
      throwOnErr(err);
      var shortLink = buildShortLink(result.c),
          payload = {
            clientID: data.clientID,
            linkID: result.c,
            shortLink: shortLink,
            longLink: data.url,
            enterDate: new Date,
            hits: 0
          };

      links.insert(payload, { safe: true },
        function(err, result) {
          throwOnErr(err);
          cb(shortLink);
        }
      );
    }
  );
}

var buildShortLink = function(linkID) {
  var cnt = lan.length,
      urlBuild = ['http://kili.us/+/'],
      nextID = linkID,
      addToURL = function(n) { urlBuild.push(lan[Math.floor(n%cnt)]); };

  // Get the next base 'cnt' number
  while (nextID >= cnt) {
    addToURL(nextID);
    nextID /= cnt;
  }

  addToURL(nextID);

  return urlBuild.join('');
}

exports.shorten = function(data, cb, errorCB) {
   var clientID = data.clientID,
       regex = /^(?:(?:https?:\/\/)(?:[a-zA-Z0-9]*[-a-zA-Z0-9]*[a-zA-Z0-9])(?:\\.[a-zA-Z0-9]*[-a-zA-Z0-9]*[a-zA-Z0-9])*(?:\\.[a-zA-Z]{2,6}))$/;

   if (data && data.url) {
     // Validiate the url against our regex
     regex.exec(data.url);

     // Check for black-listed clients
     if (blacklist[clientID] !== undefined) {
       // TODO: Blacklist error
       errorCB(BLACKLIST);
     }

     // Throttle the connected client
     if (clients[clientID] === undefined) {
       // First time
       clients[clientID] = 0;
       setTimeout(function() {
         // After 24 hours, reset the throttling
         delete clients[clientID];
       }, 86400000);

       getNextShortenedURL(data, cb);

     } else if (clients[clientID] < 25) {
       clients[clientID] += 1;
       getNextShortenedURL(data, cb);
     } else {
       // TODO: Throttle limit error
       errorCB(LIMIT);
     }
   }
}