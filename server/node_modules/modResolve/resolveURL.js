//////////////////////////////////////////////////////////////////////////
// File: resolveURL.js
//
// Description: 
//   Resolves a URL from the server backend
//
//////////////////////////////////////////////////////////////////////////
var regex = /^\/\+\/([0-9bcdfghjklmnpqrstvwxyz]+)$/,
    transform = require('../modTransform/transformService.js');

/**
 * Resolves the given URL to the address to forward to
 *
 * @param data - Object containing the database, client info, and URL
 * @param cb - Callback when successfully resolved
 * @param errCB - Callback when there is a problem
 */
exports.resolveURL = function (data, cb, errCB) {
  var match = regex.exec(data.uri),
      id = "",
      links = data.database.collection('links'),
      payload = {};

  // Validate the URL
  if (match === null) {
    // TODO
    errCB();
  } else if (match.length < 2) {
    errCB();
  } else {
    id = transform.urlToLinkID(match[1]);
    payload = {
      date: new Date,
      address: data.clientID,
      userAgent: data.userAgent
    }
    links.findAndModify({linkID: id}, [], { $push: {hits: payload }}, {safe: true},
        function(err, result) {
          if (err) {
            errCB({
              error: err
            }); // TODO
          } else {
            // Check if the link is valid
            cb(result.longLink);
          }
        }
    );
  }
}